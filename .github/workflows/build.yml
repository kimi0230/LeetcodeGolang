name: Build and Deploy MkDocs

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install dependencies
        run: |
          pip install mkdocs-material \
                      mkdocs-minify-plugin \
                      mkdocs-awesome-pages-plugin \
                      mkdocs-mermaid2-plugin

      - name: Deploy to GitHub Pages
        run: |
          # 1. ç·¨è­¯ç¶²ç«™
          mkdocs build --clean
          
          # 2. æœå°‹ä¸¦åŠ å¯†æ‰€æœ‰ solution ç›¸é—œçš„ HTML
          echo "Searching for solution files to encrypt..."
          FOUND_FILES=$(find site -path "*/README_solution/index.html")
          
          if [ -z "$FOUND_FILES" ]; then
            echo "âš ï¸ No solution files found! Please check your directory structure."
            exit 1
          fi

          for file in $FOUND_FILES; do
            echo "ğŸ”’ Encrypting $file"
            npx staticrypt "$file" -p "111" -o "$file" --title "å—ä¿è­·çš„è§£æ³•" --instructions "è«‹è¼¸å…¥å¯†ç¢¼ä»¥æŸ¥çœ‹è§£é¡Œæ€è·¯ã€‚"
          done

          # 3. éƒ¨ç½²åˆ° GitHub Pages
          pip install ghp-import
          ghp-import -n -p -f site
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
